
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>xija.component.heat &#8212; xija 4.23.1 documentation</title>
    <link rel="stylesheet" href="../../../_static/bootstrap-astropy.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <script type="text/javascript" src="../../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../../_static/copybutton.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../../index.html"><span id="logotext1">Ska!</span><span id="logotext2">xija</span><span id="logotext3"></span></a>
  <ul>
    
    <li><a class="home" title="Homepage" href="https://cxc.cfa.harvard.edu/mta/ASPECT/tool_doc">
        <span id="logotext1">ska</span><span id="logotext2">tools</span>
    </a></li>
    <li><a title="General Index" href="../../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../../index.html">xija 4.23.1 documentation</a>
	 &#187;
      </li>
      <li><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for xija.component.heat</h1><div class="highlight"><pre>
<span></span><span class="c1"># Licensed under a 3-clause BSD style license - see LICENSE.rst</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">count</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">jit</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.interpolate</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">Ska.Numpy</span>
    <span class="kn">from</span> <span class="nn">Ska.Matplotlib</span> <span class="kn">import</span> <span class="n">plot_cxctime</span>
    <span class="kn">from</span> <span class="nn">Chandra.Time</span> <span class="kn">import</span> <span class="n">DateTime</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">ModelComponent</span><span class="p">,</span> <span class="n">TelemData</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">tmal</span>


<div class="viewcode-block" id="PrecomputedHeatPower"><a class="viewcode-back" href="../../../api.html#xija.component.heat.PrecomputedHeatPower">[docs]</a><span class="k">class</span> <span class="nc">PrecomputedHeatPower</span><span class="p">(</span><span class="n">ModelComponent</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Component that provides static (precomputed) direct heat power input&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mvals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dvals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmal_ints</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmal</span><span class="o">.</span><span class="n">OPCODES</span><span class="p">[</span><span class="s1">&#39;precomputed_heat&#39;</span><span class="p">],</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">mvals_i</span><span class="p">,</span>  <span class="c1"># dy1/dt index</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">mvals_i</span><span class="p">,</span>
                          <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmal_floats</span> <span class="o">=</span> <span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">linear</span><span class="p">(</span><span class="n">days</span><span class="p">,</span> <span class="n">k_inv</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">days</span> <span class="o">/</span> <span class="n">k_inv</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">exp</span><span class="p">(</span><span class="n">days</span><span class="p">,</span> <span class="n">tau</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">days</span> <span class="o">/</span> <span class="n">tau</span><span class="p">)</span></div>


<div class="viewcode-block" id="ActiveHeatPower"><a class="viewcode-back" href="../../../api.html#xija.component.heat.ActiveHeatPower">[docs]</a><span class="k">class</span> <span class="nc">ActiveHeatPower</span><span class="p">(</span><span class="n">ModelComponent</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Component that provides active heat power input which depends on</span>
<span class="sd">    current or past computed model values</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="SolarHeatOffNomRoll"><a class="viewcode-back" href="../../../api.html#xija.component.heat.SolarHeatOffNomRoll">[docs]</a><span class="k">class</span> <span class="nc">SolarHeatOffNomRoll</span><span class="p">(</span><span class="n">PrecomputedHeatPower</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Heating of a +Y or -Y face of a spacecraft component due to off-nominal roll.  The</span>
<span class="sd">    heating is proportional to the projection of the sun on body +Y axis (which is a value</span>
<span class="sd">    from -1 to 1).  There are two parameters ``P_plus_y`` and ``P_minus_y``.  For sun on</span>
<span class="sd">    the +Y side the ``P_plus_y`` parameter is used, and likewise for sun on -Y.  For</span>
<span class="sd">    example for +Y sun::</span>

<span class="sd">       heat = P_plus_y * sun_body_y</span>

<span class="sd">    The following reference has useful diagrams concerning off-nominal roll and</span>
<span class="sd">    projections: http://occweb.cfa.harvard.edu/twiki/pub/Aspect/WebHome/ROLLDEV3.pdf.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">pitch_comp</span><span class="o">=</span><span class="s1">&#39;pitch&#39;</span><span class="p">,</span> <span class="n">roll_comp</span><span class="o">=</span><span class="s1">&#39;roll&#39;</span><span class="p">,</span> <span class="n">eclipse_comp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">P_plus_y</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">P_minus_y</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="n">ModelComponent</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_comp</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pitch_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_comp</span><span class="p">(</span><span class="n">pitch_comp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roll_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_comp</span><span class="p">(</span><span class="n">roll_comp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eclipse_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_comp</span><span class="p">(</span><span class="n">eclipse_comp</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_par</span><span class="p">(</span><span class="s1">&#39;P_plus_y&#39;</span><span class="p">,</span> <span class="n">P_plus_y</span><span class="p">,</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">5.0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_par</span><span class="p">(</span><span class="s1">&#39;P_minus_y&#39;</span><span class="p">,</span> <span class="n">P_minus_y</span><span class="p">,</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">5.0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_mvals</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dvals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;sun_body_y&#39;</span><span class="p">):</span>
            <span class="c1"># Compute the projection of the sun vector on the body +Y axis.</span>
            <span class="c1"># Pitch and off-nominal roll (theta_S and d_phi in OFLS terminology)</span>
            <span class="n">theta_S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pitch_comp</span><span class="o">.</span><span class="n">dvals</span><span class="p">)</span>
            <span class="n">d_phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roll_comp</span><span class="o">.</span><span class="n">dvals</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sun_body_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta_S</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">d_phi</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plus_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sun_body_y</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_dvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plus_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">P_plus_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">P_minus_y</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sun_body_y</span>

        <span class="c1"># Set power to 0.0 during eclipse (where eclipse_comp.dvals == True)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eclipse_comp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dvals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">eclipse_comp</span><span class="o">.</span><span class="n">dvals</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dvals</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;solarheat_off_nom_roll__</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span></div>


<div class="viewcode-block" id="SolarHeat"><a class="viewcode-back" href="../../../api.html#xija.component.heat.SolarHeat">[docs]</a><span class="k">class</span> <span class="nc">SolarHeat</span><span class="p">(</span><span class="n">PrecomputedHeatPower</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Solar heating (pitch dependent)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model :</span>
<span class="sd">        parent model</span>
<span class="sd">    node :</span>
<span class="sd">        node which is coupled to solar heat</span>
<span class="sd">    pitch_comp :</span>
<span class="sd">        solar Pitch component</span>
<span class="sd">    eclipse_comp :</span>
<span class="sd">        Eclipse component (optional)</span>
<span class="sd">    P_pitches :</span>
<span class="sd">        list of pitch values (default=[45, 65, 90, 130, 180])</span>
<span class="sd">    Ps :</span>
<span class="sd">        list of solar heating values (default=[1.0, ...])</span>
<span class="sd">    dPs :</span>
<span class="sd">        list of delta heating values (default=[0.0, ...])</span>
<span class="sd">    var_func :</span>
<span class="sd">        variability function (&#39;exp&#39; | &#39;linear&#39;)</span>
<span class="sd">    tau :</span>
<span class="sd">        variability timescale (days)</span>
<span class="sd">    ampl :</span>
<span class="sd">        ampl of annual sinusoidal heating variation</span>
<span class="sd">    bias :</span>
<span class="sd">        constant offset to all solar heating values</span>
<span class="sd">    epoch :</span>
<span class="sd">        reference date at which ``Ps`` values apply</span>
<span class="sd">    dP_pitches :</span>
<span class="sd">        list of pitch values for dP (default=``P_pitches``)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">pitch_comp</span><span class="o">=</span><span class="s1">&#39;pitch&#39;</span><span class="p">,</span> <span class="n">eclipse_comp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">P_pitches</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Ps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dPs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">var_func</span><span class="o">=</span><span class="s1">&#39;exp&#39;</span><span class="p">,</span>
                 <span class="n">tau</span><span class="o">=</span><span class="mf">1732.0</span><span class="p">,</span> <span class="n">ampl</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="s1">&#39;2010:001:12:00:00&#39;</span><span class="p">,</span>
                 <span class="n">dP_pitches</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">ModelComponent</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_comp</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pitch_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_comp</span><span class="p">(</span><span class="n">pitch_comp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eclipse_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_comp</span><span class="p">(</span><span class="n">eclipse_comp</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">P_pitches</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">P_pitches</span> <span class="o">=</span> <span class="p">[</span><span class="mi">45</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">130</span><span class="p">,</span> <span class="mi">180</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P_pitches</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">P_pitches</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_pitches</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P_pitches</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dP_pitches</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dP_pitches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">P_pitches</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dP_pitches</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dP_pitches</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dP_pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">P_pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">dP_pitches</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">P_pitches</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;P_pitches and dP_pitches must span the same pitch range&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">Ps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Ps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P_pitches</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Ps</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dPs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dPs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dP_pitches</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dPs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dPs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="n">epoch</span>

        <span class="k">for</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">power</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P_pitches</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ps</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_par</span><span class="p">(</span><span class="s1">&#39;P_</span><span class="si">{0:.0f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">pitch</span><span class="p">)),</span> <span class="n">power</span><span class="p">,</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">10.0</span><span class="p">,</span>
                         <span class="nb">max</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">dpower</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dP_pitches</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dPs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_par</span><span class="p">(</span><span class="s1">&#39;dP_</span><span class="si">{0:.0f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">pitch</span><span class="p">)),</span> <span class="n">dpower</span><span class="p">,</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span>
                         <span class="nb">max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_par</span><span class="p">(</span><span class="s1">&#39;tau&#39;</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">1000.</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">3000.</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_par</span><span class="p">(</span><span class="s1">&#39;ampl&#39;</span><span class="p">,</span> <span class="n">ampl</span><span class="p">,</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_par</span><span class="p">(</span><span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="n">bias</span><span class="p">,</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_mvals</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_func</span><span class="p">)</span>

    <span class="n">_t_phase</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">t_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t_phase</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">time2000</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="s1">&#39;2000:001:00:00:00&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">secs</span>
            <span class="n">time2010</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="s1">&#39;2010:001:00:00:00&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">secs</span>
            <span class="n">secs_per_year</span> <span class="o">=</span> <span class="p">(</span><span class="n">time2010</span> <span class="o">-</span> <span class="n">time2000</span><span class="p">)</span> <span class="o">/</span> <span class="mf">10.0</span>
            <span class="n">t_year</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pitch_comp</span><span class="o">.</span><span class="n">times</span> <span class="o">-</span> <span class="n">time2000</span><span class="p">)</span> <span class="o">/</span> <span class="n">secs_per_year</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_t_phase</span> <span class="o">=</span> <span class="n">t_year</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t_phase</span>

    <span class="nd">@t_phase</span><span class="o">.</span><span class="n">deleter</span>
    <span class="k">def</span> <span class="nf">t_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_t_phase</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epoch</span>

    <span class="nd">@epoch</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_epoch&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;can only reset the epoch for var_func=linear&#39;</span><span class="p">)</span>

            <span class="n">new_epoch</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">epoch</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span>
            <span class="n">days</span> <span class="o">=</span> <span class="n">new_epoch</span> <span class="o">-</span> <span class="n">epoch</span>

            <span class="c1"># Don&#39;t make tiny updates to epoch</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">days</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="c1"># Update the Ps params in place.  Note that self.Ps is basically for</span>
            <span class="c1"># setting the array size whereas the self.pars vals are the actual values</span>
            <span class="c1"># taken from the model spec file and used in fitting.</span>
            <span class="n">Ps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parvals</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">n_pitches</span><span class="p">]</span>
            <span class="n">dPs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parvals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">n_pitches</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">n_pitches</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dP_pitches</span><span class="p">)]</span>
            <span class="n">dPs_interp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">P_pitches</span><span class="p">,</span> <span class="n">xp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dP_pitches</span><span class="p">,</span> <span class="n">fp</span><span class="o">=</span><span class="n">dPs</span><span class="p">)</span>

            <span class="n">Ps</span> <span class="o">+=</span> <span class="n">dPs_interp</span> <span class="o">*</span> <span class="n">days</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span>
            <span class="k">for</span> <span class="n">par</span><span class="p">,</span> <span class="n">P</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">,</span> <span class="n">Ps</span><span class="p">):</span>
                <span class="n">par</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">P</span>
                <span class="k">if</span> <span class="n">P</span> <span class="o">&gt;</span> <span class="n">par</span><span class="o">.</span><span class="n">max</span><span class="p">:</span>
                    <span class="n">par</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">P</span>
                <span class="k">elif</span> <span class="n">P</span> <span class="o">&lt;</span> <span class="n">par</span><span class="o">.</span><span class="n">min</span><span class="p">:</span>
                    <span class="n">par</span><span class="o">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">P</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Updated model component </span><span class="si">{}</span><span class="s1"> epoch from </span><span class="si">{}</span><span class="s1"> to </span><span class="si">{}</span><span class="s1">&#39;</span>
                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="o">.</span><span class="n">date</span><span class="p">[:</span><span class="mi">8</span><span class="p">],</span> <span class="n">new_epoch</span><span class="o">.</span><span class="n">date</span><span class="p">[:</span><span class="mi">8</span><span class="p">]))</span>

            <span class="c1"># In order to capture the new epoch when saving the model we need to</span>
            <span class="c1"># update ``init_kwargs`` since this isn&#39;t a formal model parameter</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init_kwargs</span><span class="p">[</span><span class="s1">&#39;epoch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_epoch</span><span class="o">.</span><span class="n">date</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span>

            <span class="c1"># Delete these cached attributes which depend on epoch</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_days</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_phase</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_epoch</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="SolarHeat.dvals_post_hook"><a class="viewcode-back" href="../../../api.html#xija.component.heat.SolarHeat.dvals_post_hook">[docs]</a>    <span class="k">def</span> <span class="nf">dvals_post_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Override this method to adjust self._dvals after main computation.&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="k">def</span> <span class="nf">_compute_dvals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">vf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_days</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P_vals</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dP_vals</span> <span class="o">*</span> <span class="n">vf</span> <span class="o">+</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ampl</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_phase</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dvals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;pitches&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pitches</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pitch_comp</span><span class="o">.</span><span class="n">dvals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">P_pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">P_pitches</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;t_days&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t_days</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pitch_comp</span><span class="o">.</span><span class="n">times</span>
                           <span class="o">-</span> <span class="n">DateTime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span><span class="o">.</span><span class="n">secs</span><span class="p">)</span> <span class="o">/</span> <span class="mf">86400.0</span>

        <span class="n">Ps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parvals</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">n_pitches</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span>
        <span class="n">dPs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parvals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">n_pitches</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">n_pitches</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dP_pitches</span><span class="p">)]</span>

        <span class="n">Ps_interp</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P_pitches</span><span class="p">,</span> <span class="n">Ps</span><span class="p">,</span>
                                               <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>
        <span class="n">dPs_interp</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dP_pitches</span><span class="p">,</span> <span class="n">dPs</span><span class="p">,</span>
                                                <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P_vals</span> <span class="o">=</span> <span class="n">Ps_interp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pitches</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dP_vals</span> <span class="o">=</span> <span class="n">dPs_interp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pitches</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_dvals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_dvals</span><span class="p">()</span>

        <span class="c1"># Set power to 0.0 during eclipse (where eclipse_comp.dvals == True)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eclipse_comp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dvals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">eclipse_comp</span><span class="o">.</span><span class="n">dvals</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># Allow for customization in SolarHeat subclasses</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dvals_post_hook</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dvals</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;solarheat__</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_solar_heat__pitch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
        <span class="n">Ps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parvals</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">n_pitches</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span>
        <span class="n">Ps_interp</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P_pitches</span><span class="p">,</span> <span class="n">Ps</span><span class="p">,</span>
                                               <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>

        <span class="n">dPs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parvals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">n_pitches</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">n_pitches</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dP_pitches</span><span class="p">)]</span>
        <span class="n">dPs_interp</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dP_pitches</span><span class="p">,</span> <span class="n">dPs</span><span class="p">,</span>
                                                <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>

        <span class="n">pitches</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P_pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">P_pitches</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">P_vals</span> <span class="o">=</span> <span class="n">Ps_interp</span><span class="p">(</span><span class="n">pitches</span><span class="p">)</span>
        <span class="n">dP_vals</span> <span class="o">=</span> <span class="n">dPs_interp</span><span class="p">(</span><span class="n">pitches</span><span class="p">)</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P_pitches</span><span class="p">,</span> <span class="n">Ps</span><span class="p">)</span>
            <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">pitches</span><span class="p">,</span> <span class="n">P_vals</span><span class="p">)</span>
            <span class="n">lines</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">pitches</span><span class="p">,</span> <span class="n">dP_vals</span> <span class="o">+</span> <span class="n">P_vals</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P_pitches</span><span class="p">,</span> <span class="n">Ps</span><span class="p">,</span> <span class="s1">&#39;or&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pitches</span><span class="p">,</span> <span class="n">P_vals</span><span class="p">,</span> <span class="s1">&#39;-b&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pitches</span><span class="p">,</span> <span class="n">dP_vals</span> <span class="o">+</span> <span class="n">P_vals</span><span class="p">,</span> <span class="s1">&#39;-m&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> solar heat input&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">180</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span></div>


<div class="viewcode-block" id="SolarHeatMulplicative"><a class="viewcode-back" href="../../../api.html#xija.component.heat.SolarHeatMulplicative">[docs]</a><span class="k">class</span> <span class="nc">SolarHeatMulplicative</span><span class="p">(</span><span class="n">SolarHeat</span><span class="p">):</span>
    <span class="vm">__doc__</span> <span class="o">=</span> <span class="n">SolarHeat</span><span class="o">.</span><span class="vm">__doc__</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">pitch_comp</span><span class="o">=</span><span class="s1">&#39;pitch&#39;</span><span class="p">,</span> <span class="n">eclipse_comp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">P_pitches</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Ps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dPs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">var_func</span><span class="o">=</span><span class="s1">&#39;exp&#39;</span><span class="p">,</span>
                 <span class="n">tau</span><span class="o">=</span><span class="mf">1732.0</span><span class="p">,</span> <span class="n">ampl</span><span class="o">=</span><span class="mf">0.0334</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="s1">&#39;2010:001:12:00:00&#39;</span><span class="p">,</span>
                 <span class="n">dP_pitches</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">model</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">pitch_comp</span><span class="o">=</span><span class="n">pitch_comp</span><span class="p">,</span> <span class="n">eclipse_comp</span><span class="o">=</span><span class="n">eclipse_comp</span><span class="p">,</span>
            <span class="n">P_pitches</span><span class="o">=</span><span class="n">P_pitches</span><span class="p">,</span> <span class="n">Ps</span><span class="o">=</span><span class="n">Ps</span><span class="p">,</span> <span class="n">dPs</span><span class="o">=</span><span class="n">dPs</span><span class="p">,</span> <span class="n">var_func</span><span class="o">=</span><span class="n">var_func</span><span class="p">,</span>
            <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> <span class="n">ampl</span><span class="o">=</span><span class="n">ampl</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">,</span> <span class="n">dP_pitches</span><span class="o">=</span><span class="n">dP_pitches</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute_dvals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">vf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_days</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">)</span>
        <span class="n">yv</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ampl</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_phase</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">P_vals</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dP_vals</span> <span class="o">*</span> <span class="n">vf</span><span class="p">)</span> <span class="o">*</span> <span class="n">yv</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="SolarHeatAcisCameraBody"><a class="viewcode-back" href="../../../api.html#xija.component.heat.SolarHeatAcisCameraBody">[docs]</a><span class="k">class</span> <span class="nc">SolarHeatAcisCameraBody</span><span class="p">(</span><span class="n">SolarHeat</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Solar heating (pitch and SIM-Z dependent)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model :</span>
<span class="sd">        parent model</span>
<span class="sd">    node :</span>
<span class="sd">        node which is coupled to solar heat</span>
<span class="sd">    simz_comp :</span>
<span class="sd">        SimZ component</span>
<span class="sd">    pitch_comp :</span>
<span class="sd">        solar Pitch component</span>
<span class="sd">    eclipse_comp :</span>
<span class="sd">        Eclipse component (optional)</span>
<span class="sd">    P_pitches :</span>
<span class="sd">        list of pitch values (default=[45, 65, 90, 130, 180])</span>
<span class="sd">    Ps :</span>
<span class="sd">        list of solar heating values (default=[1.0, ...])</span>
<span class="sd">    dPs :</span>
<span class="sd">        list of delta heating values (default=[0.0, ...])</span>
<span class="sd">    var_func :</span>
<span class="sd">        variability function (&#39;exp&#39; | &#39;linear&#39;)</span>
<span class="sd">    tau :</span>
<span class="sd">        variability timescale (days)</span>
<span class="sd">    ampl :</span>
<span class="sd">        ampl of annual sinusoidal heating variation</span>
<span class="sd">    bias :</span>
<span class="sd">        constant offset to all solar heating values</span>
<span class="sd">    epoch :</span>
<span class="sd">        reference date at which ``Ps`` values apply</span>
<span class="sd">    dh_heater_comp :</span>
<span class="sd">        detector housing heater status (True = On)</span>
<span class="sd">    dh_heater_bias :</span>
<span class="sd">        bias power when DH heater is on</span>
<span class="sd">    dP_pitches :</span>
<span class="sd">        list of pitch values for dP (default=``P_pitches``)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">pitch_comp</span><span class="o">=</span><span class="s1">&#39;pitch&#39;</span><span class="p">,</span> <span class="n">eclipse_comp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">P_pitches</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Ps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dPs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">var_func</span><span class="o">=</span><span class="s1">&#39;exp&#39;</span><span class="p">,</span>
                 <span class="n">tau</span><span class="o">=</span><span class="mf">1732.0</span><span class="p">,</span> <span class="n">ampl</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="s1">&#39;2010:001:12:00:00&#39;</span><span class="p">,</span>
                 <span class="n">dh_heater_comp</span><span class="o">=</span><span class="s1">&#39;dh_heater&#39;</span><span class="p">,</span> <span class="n">dh_heater_bias</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">dP_pitches</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">model</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">pitch_comp</span><span class="o">=</span><span class="n">pitch_comp</span><span class="p">,</span> <span class="n">eclipse_comp</span><span class="o">=</span><span class="n">eclipse_comp</span><span class="p">,</span>
            <span class="n">P_pitches</span><span class="o">=</span><span class="n">P_pitches</span><span class="p">,</span> <span class="n">Ps</span><span class="o">=</span><span class="n">Ps</span><span class="p">,</span> <span class="n">dPs</span><span class="o">=</span><span class="n">dPs</span><span class="p">,</span> <span class="n">var_func</span><span class="o">=</span><span class="n">var_func</span><span class="p">,</span>
            <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> <span class="n">ampl</span><span class="o">=</span><span class="n">ampl</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">,</span> <span class="n">dP_pitches</span><span class="o">=</span><span class="n">dP_pitches</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dh_heater_comp</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_comp</span><span class="p">(</span><span class="n">dh_heater_comp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_par</span><span class="p">(</span><span class="s1">&#39;dh_heater_bias&#39;</span><span class="p">,</span> <span class="n">dh_heater_bias</span><span class="p">,</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

<div class="viewcode-block" id="SolarHeatAcisCameraBody.dvals_post_hook"><a class="viewcode-back" href="../../../api.html#xija.component.heat.SolarHeatAcisCameraBody.dvals_post_hook">[docs]</a>    <span class="k">def</span> <span class="nf">dvals_post_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply a bias power offset when detector housing heater is on&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dvals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dh_heater_comp</span><span class="o">.</span><span class="n">dvals</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dh_heater_bias</span></div></div>


<div class="viewcode-block" id="SolarHeatHrc"><a class="viewcode-back" href="../../../api.html#xija.component.heat.SolarHeatHrc">[docs]</a><span class="k">class</span> <span class="nc">SolarHeatHrc</span><span class="p">(</span><span class="n">SolarHeat</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Solar heating (pitch and SIM-Z dependent)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model :</span>
<span class="sd">        parent model</span>
<span class="sd">    node :</span>
<span class="sd">        node which is coupled to solar heat</span>
<span class="sd">    simz_comp :</span>
<span class="sd">        SimZ component</span>
<span class="sd">    pitch_comp :</span>
<span class="sd">        solar Pitch component</span>
<span class="sd">    eclipse_comp :</span>
<span class="sd">        Eclipse component (optional)</span>
<span class="sd">    P_pitches :</span>
<span class="sd">        list of pitch values (default=[45, 65, 90, 130, 180])</span>
<span class="sd">    Ps :</span>
<span class="sd">        list of solar heating values (default=[1.0, ...])</span>
<span class="sd">    dPs :</span>
<span class="sd">        list of delta heating values (default=[0.0, ...])</span>
<span class="sd">    var_func :</span>
<span class="sd">        variability function (&#39;exp&#39; | &#39;linear&#39;)</span>
<span class="sd">    tau :</span>
<span class="sd">        variability timescale (days)</span>
<span class="sd">    ampl :</span>
<span class="sd">        ampl of annual sinusoidal heating variation</span>
<span class="sd">    bias :</span>
<span class="sd">        constant offset to all solar heating values</span>
<span class="sd">    epoch :</span>
<span class="sd">        reference date at which ``Ps`` values apply</span>
<span class="sd">    hrc_bias :</span>
<span class="sd">        solar heating bias when SIM-Z &lt; 0 (HRC)</span>
<span class="sd">    dP_pitches :</span>
<span class="sd">        list of pitch values for dP (default=``P_pitches``)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">simz_comp</span><span class="o">=</span><span class="s1">&#39;sim_z&#39;</span><span class="p">,</span> <span class="n">pitch_comp</span><span class="o">=</span><span class="s1">&#39;pitch&#39;</span><span class="p">,</span> <span class="n">eclipse_comp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">P_pitches</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Ps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dPs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">var_func</span><span class="o">=</span><span class="s1">&#39;exp&#39;</span><span class="p">,</span>
                 <span class="n">tau</span><span class="o">=</span><span class="mf">1732.0</span><span class="p">,</span> <span class="n">ampl</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="s1">&#39;2010:001:12:00:00&#39;</span><span class="p">,</span>
                 <span class="n">hrc_bias</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">dP_pitches</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">model</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">pitch_comp</span><span class="o">=</span><span class="n">pitch_comp</span><span class="p">,</span> <span class="n">eclipse_comp</span><span class="o">=</span><span class="n">eclipse_comp</span><span class="p">,</span>
            <span class="n">P_pitches</span><span class="o">=</span><span class="n">P_pitches</span><span class="p">,</span> <span class="n">Ps</span><span class="o">=</span><span class="n">Ps</span><span class="p">,</span> <span class="n">dPs</span><span class="o">=</span><span class="n">dPs</span><span class="p">,</span> <span class="n">var_func</span><span class="o">=</span><span class="n">var_func</span><span class="p">,</span>
            <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> <span class="n">ampl</span><span class="o">=</span><span class="n">ampl</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">,</span> <span class="n">dP_pitches</span><span class="o">=</span><span class="n">dP_pitches</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">simz_comp</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_comp</span><span class="p">(</span><span class="n">simz_comp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_par</span><span class="p">(</span><span class="s1">&#39;hrc_bias&#39;</span><span class="p">,</span> <span class="n">hrc_bias</span><span class="p">,</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

<div class="viewcode-block" id="SolarHeatHrc.dvals_post_hook"><a class="viewcode-back" href="../../../api.html#xija.component.heat.SolarHeatHrc.dvals_post_hook">[docs]</a>    <span class="k">def</span> <span class="nf">dvals_post_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply a bias power offset when SIM-Z is at HRC-S or HRC-I.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;hrc_mask&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hrc_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simz_comp</span><span class="o">.</span><span class="n">dvals</span> <span class="o">&lt;</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dvals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hrc_mask</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hrc_bias</span></div></div>


<div class="viewcode-block" id="SolarHeatHrcOpts"><a class="viewcode-back" href="../../../api.html#xija.component.heat.SolarHeatHrcOpts">[docs]</a><span class="k">class</span> <span class="nc">SolarHeatHrcOpts</span><span class="p">(</span><span class="n">SolarHeat</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Solar heating (pitch and SIM-Z dependent, two parameters for</span>
<span class="sd">    HRC-I and HRC-S)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model :</span>
<span class="sd">        parent model</span>
<span class="sd">    node :</span>
<span class="sd">        node which is coupled to solar heat</span>
<span class="sd">    simz_comp :</span>
<span class="sd">        SimZ component</span>
<span class="sd">    pitch_comp :</span>
<span class="sd">        solar Pitch component</span>
<span class="sd">    eclipse_comp :</span>
<span class="sd">        Eclipse component (optional)</span>
<span class="sd">    P_pitches :</span>
<span class="sd">        list of pitch values (default=[45, 65, 90, 130, 180])</span>
<span class="sd">    Ps :</span>
<span class="sd">        list of solar heating values (default=[1.0, ...])</span>
<span class="sd">    dPs :</span>
<span class="sd">        list of delta heating values (default=[0.0, ...])</span>
<span class="sd">    var_func :</span>
<span class="sd">        variability function (&#39;exp&#39; | &#39;linear&#39;)</span>
<span class="sd">    tau :</span>
<span class="sd">        variability timescale (days)</span>
<span class="sd">    ampl :</span>
<span class="sd">        ampl of annual sinusoidal heating variation</span>
<span class="sd">    bias :</span>
<span class="sd">        constant offset to all solar heating values</span>
<span class="sd">    epoch :</span>
<span class="sd">        reference date at which ``Ps`` values apply</span>
<span class="sd">    hrci_bias :</span>
<span class="sd">        solar heating bias when HRC-I is in the focal plane.</span>
<span class="sd">    hrcs_bias :</span>
<span class="sd">        solar heating bias when HRC-S is in the focal plane.</span>
<span class="sd">    dP_pitches :</span>
<span class="sd">        list of pitch values for dP (default=``P_pitches``)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">simz_comp</span><span class="o">=</span><span class="s1">&#39;sim_z&#39;</span><span class="p">,</span> <span class="n">pitch_comp</span><span class="o">=</span><span class="s1">&#39;pitch&#39;</span><span class="p">,</span> <span class="n">eclipse_comp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">P_pitches</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Ps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dPs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">var_func</span><span class="o">=</span><span class="s1">&#39;exp&#39;</span><span class="p">,</span>
                 <span class="n">tau</span><span class="o">=</span><span class="mf">1732.0</span><span class="p">,</span> <span class="n">ampl</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="s1">&#39;2010:001:12:00:00&#39;</span><span class="p">,</span>
                 <span class="n">hrci_bias</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">hrcs_bias</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">dP_pitches</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">model</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">pitch_comp</span><span class="o">=</span><span class="n">pitch_comp</span><span class="p">,</span> <span class="n">eclipse_comp</span><span class="o">=</span><span class="n">eclipse_comp</span><span class="p">,</span>
            <span class="n">P_pitches</span><span class="o">=</span><span class="n">P_pitches</span><span class="p">,</span> <span class="n">Ps</span><span class="o">=</span><span class="n">Ps</span><span class="p">,</span> <span class="n">dPs</span><span class="o">=</span><span class="n">dPs</span><span class="p">,</span> <span class="n">var_func</span><span class="o">=</span><span class="n">var_func</span><span class="p">,</span>
            <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> <span class="n">ampl</span><span class="o">=</span><span class="n">ampl</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">,</span> <span class="n">dP_pitches</span><span class="o">=</span><span class="n">dP_pitches</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">simz_comp</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_comp</span><span class="p">(</span><span class="n">simz_comp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_par</span><span class="p">(</span><span class="s1">&#39;hrci_bias&#39;</span><span class="p">,</span> <span class="n">hrci_bias</span><span class="p">,</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_par</span><span class="p">(</span><span class="s1">&#39;hrcs_bias&#39;</span><span class="p">,</span> <span class="n">hrcs_bias</span><span class="p">,</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

<div class="viewcode-block" id="SolarHeatHrcOpts.dvals_post_hook"><a class="viewcode-back" href="../../../api.html#xija.component.heat.SolarHeatHrcOpts.dvals_post_hook">[docs]</a>    <span class="k">def</span> <span class="nf">dvals_post_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply a bias power offset when SIM-Z is at HRC-S or HRC-I.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;hrci_mask&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hrci_mask</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simz_comp</span><span class="o">.</span><span class="n">dvals</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> \
                             <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simz_comp</span><span class="o">.</span><span class="n">dvals</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">86147</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dvals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hrci_mask</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hrci_bias</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;hrcs_mask&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hrcs_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simz_comp</span><span class="o">.</span><span class="n">dvals</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">86147</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dvals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hrcs_mask</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hrcs_bias</span></div></div>


<div class="viewcode-block" id="SolarHeatHrcMult"><a class="viewcode-back" href="../../../api.html#xija.component.heat.SolarHeatHrcMult">[docs]</a><span class="k">class</span> <span class="nc">SolarHeatHrcMult</span><span class="p">(</span><span class="n">SolarHeatHrcOpts</span><span class="p">,</span> <span class="n">SolarHeatMulplicative</span><span class="p">):</span>
    <span class="vm">__doc__</span> <span class="o">=</span> <span class="n">SolarHeatHrcOpts</span><span class="o">.</span><span class="vm">__doc__</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">simz_comp</span><span class="o">=</span><span class="s1">&#39;sim_z&#39;</span><span class="p">,</span> <span class="n">pitch_comp</span><span class="o">=</span><span class="s1">&#39;pitch&#39;</span><span class="p">,</span> <span class="n">eclipse_comp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">P_pitches</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Ps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dPs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">var_func</span><span class="o">=</span><span class="s1">&#39;exp&#39;</span><span class="p">,</span>
                 <span class="n">tau</span><span class="o">=</span><span class="mf">1732.0</span><span class="p">,</span> <span class="n">ampl</span><span class="o">=</span><span class="mf">0.0334</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="s1">&#39;2010:001:12:00:00&#39;</span><span class="p">,</span>
                 <span class="n">hrci_bias</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">hrcs_bias</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">dP_pitches</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">model</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">simz_comp</span><span class="o">=</span><span class="n">simz_comp</span><span class="p">,</span> <span class="n">pitch_comp</span><span class="o">=</span><span class="n">pitch_comp</span><span class="p">,</span> <span class="n">eclipse_comp</span><span class="o">=</span><span class="n">eclipse_comp</span><span class="p">,</span>
            <span class="n">P_pitches</span><span class="o">=</span><span class="n">P_pitches</span><span class="p">,</span> <span class="n">Ps</span><span class="o">=</span><span class="n">Ps</span><span class="p">,</span> <span class="n">dPs</span><span class="o">=</span><span class="n">dPs</span><span class="p">,</span> <span class="n">var_func</span><span class="o">=</span><span class="n">var_func</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span>
            <span class="n">ampl</span><span class="o">=</span><span class="n">ampl</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">,</span> <span class="n">hrci_bias</span><span class="o">=</span><span class="n">hrci_bias</span><span class="p">,</span>
            <span class="n">hrcs_bias</span><span class="o">=</span><span class="n">hrcs_bias</span><span class="p">,</span> <span class="n">dP_pitches</span><span class="o">=</span><span class="n">dP_pitches</span><span class="p">)</span></div>


<span class="c1"># For back compatibility prior to Xija 0.2</span>
<span class="n">DpaSolarHeat</span> <span class="o">=</span> <span class="n">SolarHeatHrc</span>


<div class="viewcode-block" id="EarthHeat"><a class="viewcode-back" href="../../../api.html#xija.component.heat.EarthHeat">[docs]</a><span class="k">class</span> <span class="nc">EarthHeat</span><span class="p">(</span><span class="n">PrecomputedHeatPower</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Earth heating of ACIS cold radiator (attitude, ephem dependent)&quot;&quot;&quot;</span>

    <span class="n">use_earth_vis_grid</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">earth_vis_grid_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;earth_vis_grid_nside32.fits.gz&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span>
                 <span class="n">orbitephem0_x</span><span class="p">,</span> <span class="n">orbitephem0_y</span><span class="p">,</span> <span class="n">orbitephem0_z</span><span class="p">,</span>
                 <span class="n">aoattqt1</span><span class="p">,</span> <span class="n">aoattqt2</span><span class="p">,</span> <span class="n">aoattqt3</span><span class="p">,</span> <span class="n">aoattqt4</span><span class="p">,</span>
                 <span class="n">k</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="n">ModelComponent</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_comp</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orbitephem0_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_comp</span><span class="p">(</span><span class="n">orbitephem0_x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orbitephem0_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_comp</span><span class="p">(</span><span class="n">orbitephem0_y</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orbitephem0_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_comp</span><span class="p">(</span><span class="n">orbitephem0_z</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aoattqt1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_comp</span><span class="p">(</span><span class="n">aoattqt1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aoattqt2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_comp</span><span class="p">(</span><span class="n">aoattqt2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aoattqt3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_comp</span><span class="p">(</span><span class="n">aoattqt3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aoattqt4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_comp</span><span class="p">(</span><span class="n">aoattqt4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_mvals</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_par</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">calc_earth_vis_from_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ephems</span><span class="p">,</span> <span class="n">q_atts</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">astropy_healpix</span>
        <span class="n">healpix</span> <span class="o">=</span> <span class="n">astropy_healpix</span><span class="o">.</span><span class="n">HEALPix</span><span class="p">(</span><span class="n">nside</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;nested&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;earth_vis_grid&#39;</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">earth_vis_grid_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdus</span><span class="p">:</span>
                <span class="n">hdu</span> <span class="o">=</span> <span class="n">hdus</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">hdr</span> <span class="o">=</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span>
                <span class="n">vis_grid</span> <span class="o">=</span> <span class="n">hdu</span><span class="o">.</span><span class="n">data</span> <span class="o">/</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">]</span>  <span class="c1"># 12288 x 100</span>
                <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">earth_vis_grid</span> <span class="o">=</span> <span class="n">vis_grid</span>

                <span class="n">alts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;alt_min&#39;</span><span class="p">]),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;alt_max&#39;</span><span class="p">]),</span>
                                   <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;n_alt&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">log_earth_vis_dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;earthrad&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">alts</span><span class="p">)</span>

        <span class="n">ephems</span> <span class="o">=</span> <span class="n">ephems</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">dists</span><span class="p">,</span> <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span> <span class="o">=</span> <span class="n">get_dists_lons_lats</span><span class="p">(</span><span class="n">ephems</span><span class="p">,</span> <span class="n">q_atts</span><span class="p">)</span>

        <span class="n">hp_idxs</span> <span class="o">=</span> <span class="n">healpix</span><span class="o">.</span><span class="n">lonlat_to_healpix</span><span class="p">(</span><span class="n">lons</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">,</span> <span class="n">lats</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span>

        <span class="c1"># Linearly interpolate distances for appropriate healpix pixels.</span>
        <span class="c1"># Code borrowed a bit from Ska.Numpy.Numpy._interpolate_vectorized.</span>
        <span class="n">xin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_earth_vis_dists</span>
        <span class="n">xout</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span>
        <span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">xin</span><span class="p">,</span> <span class="n">xout</span><span class="p">)</span>

        <span class="c1"># Extrapolation is linear.  This should never happen in this application</span>
        <span class="c1"># because of how the grid is defined.</span>
        <span class="n">idxs</span> <span class="o">=</span> <span class="n">idxs</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">xin</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">x0</span> <span class="o">=</span> <span class="n">xin</span><span class="p">[</span><span class="n">idxs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">xin</span><span class="p">[</span><span class="n">idxs</span><span class="p">]</span>

        <span class="c1"># Note here the &quot;fancy-indexing&quot; which is indexing into a 2-d array</span>
        <span class="c1"># with two 1-d arrays.</span>
        <span class="n">y0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">earth_vis_grid</span><span class="p">[</span><span class="n">hp_idxs</span><span class="p">,</span> <span class="n">idxs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">earth_vis_grid</span><span class="p">[</span><span class="n">hp_idxs</span><span class="p">,</span> <span class="n">idxs</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_dvals</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">xout</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span> <span class="o">+</span> <span class="n">y0</span>

    <span class="k">def</span> <span class="nf">calc_earth_vis_from_taco</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ephems</span><span class="p">,</span> <span class="n">q_atts</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">acis_taco</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ephem</span><span class="p">,</span> <span class="n">q_att</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">count</span><span class="p">(),</span> <span class="n">ephems</span><span class="p">,</span> <span class="n">q_atts</span><span class="p">):</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">illums</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">acis_taco</span><span class="o">.</span><span class="n">calc_earth_vis</span><span class="p">(</span><span class="n">ephem</span><span class="p">,</span> <span class="n">q_att</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dvals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">illums</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dvals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_dvals&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cached</span><span class="p">():</span>

            <span class="c1"># Collect individual MSIDs for use in calc_earth_vis()</span>
            <span class="n">ephem_xyzs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;orbitephem0_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
                          <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">)]</span>
            <span class="n">aoattqt_1234s</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;aoattqt</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
                             <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)]</span>
            <span class="c1"># Note: the copy() here is so that the array becomes contiguous in</span>
            <span class="c1"># memory and allows numba to run faster (and avoids NumbaPerformanceWarning:</span>
            <span class="c1"># np.dot() is faster on contiguous arrays).</span>
            <span class="n">ephems</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">dvals</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ephem_xyzs</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">q_atts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">dvals</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">aoattqt_1234s</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

            <span class="c1"># Q_atts can have occasional bad values, maybe because the</span>
            <span class="c1"># Ska eng 5-min &quot;midvals&quot; are not lined up, but I&#39;m not quite sure.</span>
            <span class="c1"># TODO: this (legacy) solution isn&#39;t great.  Investigate what&#39;s</span>
            <span class="c1"># really happening.</span>
            <span class="n">q_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">q_atts</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">bad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q_norm</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.1</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">bad</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Replacing bad midval quaternions with [1,0,0,0] at times &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">times</span><span class="p">[</span><span class="n">bad</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">q_atts</span><span class="p">[</span><span class="n">bad</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
            <span class="n">q_atts</span><span class="p">[</span><span class="o">~</span><span class="n">bad</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">q_atts</span><span class="p">[</span><span class="o">~</span><span class="n">bad</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">q_norm</span><span class="p">[</span><span class="o">~</span><span class="n">bad</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

            <span class="c1"># Finally initialize dvals and update in-place appropriately</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">n_times</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_earth_vis_grid</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">calc_earth_vis_from_grid</span><span class="p">(</span><span class="n">ephems</span><span class="p">,</span> <span class="n">q_atts</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">calc_earth_vis_from_taco</span><span class="p">(</span><span class="n">ephems</span><span class="p">,</span> <span class="n">q_atts</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">put_cache</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dvals</span>

    <span class="k">def</span> <span class="nf">put_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;esa_cache&#39;</span><span class="p">):</span>
            <span class="n">cachefile</span> <span class="o">=</span> <span class="s1">&#39;esa_cache/</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">.npz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">datestart</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">datestop</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">cachefile</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">times</span><span class="p">,</span>
                     <span class="n">dvals</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dvals</span><span class="p">)</span>

<div class="viewcode-block" id="EarthHeat.get_cached"><a class="viewcode-back" href="../../../api.html#xija.component.heat.EarthHeat.get_cached">[docs]</a>    <span class="k">def</span> <span class="nf">get_cached</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find a cached version of the Earth solid angle values from</span>
<span class="sd">        file if possible.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dts</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># delta times for each matching file</span>
        <span class="n">filenames</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;esa_cache/*.npz&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="n">re_date</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;\d\d\d\d:\d\d\d:\d\d:\d\d:\d\d\.\d\d\d&#39;</span>
            <span class="n">re_cache_file</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;(</span><span class="si">{}</span><span class="s1">)-(</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">re_date</span><span class="p">,</span> <span class="n">re_date</span><span class="p">)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">re_cache_file</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">f_datestart</span><span class="p">,</span> <span class="n">f_datestop</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">f_datestart</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">datestart</span> <span class="ow">and</span>
                    <span class="n">f_datestop</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">datestop</span><span class="p">):</span>
                    <span class="n">dts</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">f_datestop</span><span class="p">)</span> <span class="o">-</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">f_datestart</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dts</span><span class="p">:</span>
            <span class="n">cachefile</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dts</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">arrays</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cachefile</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dvals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">interpolate_data</span><span class="p">(</span>
                <span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;dvals&#39;</span><span class="p">],</span> <span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">],</span> <span class="n">comp</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mvals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dvals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmal_ints</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmal</span><span class="o">.</span><span class="n">OPCODES</span><span class="p">[</span><span class="s1">&#39;precomputed_heat&#39;</span><span class="p">],</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">mvals_i</span><span class="p">,</span>  <span class="c1"># dy1/dt index</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">mvals_i</span><span class="p">,</span>  <span class="c1"># mvals with precomputed heat input</span>
                          <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmal_floats</span> <span class="o">=</span> <span class="p">()</span>

    <span class="k">def</span> <span class="nf">plot_data__time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">plot_cxctime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">times</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dvals</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span>
                         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#386cb0&#39;</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: data (blue)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Illumination (sr)&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_plotdate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dvals</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;earthheat__</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span></div>


<div class="viewcode-block" id="DetectorHousingHeater"><a class="viewcode-back" href="../../../api.html#xija.component.heat.DetectorHousingHeater">[docs]</a><span class="k">class</span> <span class="nc">DetectorHousingHeater</span><span class="p">(</span><span class="n">TelemData</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="n">TelemData</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="s1">&#39;1dahtbon&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_mvals</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fetch_attr</span> <span class="o">=</span> <span class="s1">&#39;midvals&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fetch_method</span> <span class="o">=</span> <span class="s1">&#39;nearest&#39;</span>

    <span class="k">def</span> <span class="nf">get_dvals_tlm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dahtbon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msid</span><span class="p">,</span> <span class="s1">&#39;vals&#39;</span><span class="p">,</span> <span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dahtbon</span> <span class="o">==</span> <span class="s1">&#39;ON &#39;</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dvals</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;dh_heater&#39;</span></div>


<div class="viewcode-block" id="AcisPsmcSolarHeat"><a class="viewcode-back" href="../../../api.html#xija.component.heat.AcisPsmcSolarHeat">[docs]</a><span class="k">class</span> <span class="nc">AcisPsmcSolarHeat</span><span class="p">(</span><span class="n">PrecomputedHeatPower</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Solar heating of PSMC box.  This is dependent on SIM-Z&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">pitch_comp</span><span class="o">=</span><span class="s1">&#39;pitch&#39;</span><span class="p">,</span> <span class="n">simz_comp</span><span class="o">=</span><span class="s1">&#39;sim_z&#39;</span><span class="p">,</span>
                 <span class="n">dh_heater_comp</span><span class="o">=</span><span class="s1">&#39;dh_heater&#39;</span><span class="p">,</span> <span class="n">P_pitches</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">P_vals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dPs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">var_func</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span>
                 <span class="n">tau</span><span class="o">=</span><span class="mf">1732.0</span><span class="p">,</span> <span class="n">ampl</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="s1">&#39;2013:001:12:00:00&#39;</span><span class="p">,</span> <span class="n">dh_heater</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
        <span class="n">ModelComponent</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_mvals</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_comp</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pitch_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_comp</span><span class="p">(</span><span class="n">pitch_comp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simz_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_comp</span><span class="p">(</span><span class="n">simz_comp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dh_heater_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_comp</span><span class="p">(</span><span class="n">dh_heater_comp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P_pitches</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">45.</span><span class="p">,</span> <span class="mf">55.</span><span class="p">,</span> <span class="mf">70.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">,</span> <span class="mf">150.</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="n">P_pitches</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
                                  <span class="k">else</span> <span class="n">P_pitches</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dPs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P_pitches</span><span class="p">)</span> <span class="k">if</span> <span class="n">dPs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dPs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simz_lims</span> <span class="o">=</span> <span class="p">((</span><span class="o">-</span><span class="mf">400000.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">85000.0</span><span class="p">),</span>  <span class="c1"># HRC-S</span>
                          <span class="p">(</span><span class="o">-</span><span class="mf">85000.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>        <span class="c1"># HRC-I</span>
                          <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">83000.0</span><span class="p">),</span>         <span class="c1"># ACIS-S</span>
                          <span class="p">(</span><span class="mf">83000.0</span><span class="p">,</span> <span class="mf">400000.0</span><span class="p">))</span>    <span class="c1"># ACIS-I</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">instr_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hrcs&#39;</span><span class="p">,</span> <span class="s1">&#39;hrci&#39;</span><span class="p">,</span> <span class="s1">&#39;aciss&#39;</span><span class="p">,</span> <span class="s1">&#39;acisi&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">instr_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instr_names</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">pitch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P_pitches</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_par</span><span class="p">(</span><span class="s1">&#39;P_</span><span class="si">{0}</span><span class="s1">_</span><span class="si">{1:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">instr_name</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">pitch</span><span class="p">)),</span>
                             <span class="n">P_vals</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">10.0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">pitch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dPs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_par</span><span class="p">(</span><span class="s1">&#39;dP_</span><span class="si">{0:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P_pitches</span><span class="p">[</span><span class="n">j</span><span class="p">])),</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">dPs</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_par</span><span class="p">(</span><span class="s1">&#39;tau&#39;</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">1000.</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">3000.</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_par</span><span class="p">(</span><span class="s1">&#39;ampl&#39;</span><span class="p">,</span> <span class="n">ampl</span><span class="p">,</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_par</span><span class="p">(</span><span class="s1">&#39;dh_heater&#39;</span><span class="p">,</span> <span class="n">dh_heater</span><span class="p">,</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="n">epoch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_func</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dvals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;pitches&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pitches</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pitch_comp</span><span class="o">.</span><span class="n">dvals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">P_pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">P_pitches</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;simzs&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simzs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simz_comp</span><span class="o">.</span><span class="n">dvals</span>
            <span class="c1"># Instrument 0=HRC-S 1=HRC-I 2=ACIS</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">n_times</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lims</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simz_lims</span><span class="p">):</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simzs</span> <span class="o">&gt;</span> <span class="n">lims</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simzs</span> <span class="o">&lt;=</span> <span class="n">lims</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">instrs</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;t_days&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t_days</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pitch_comp</span><span class="o">.</span><span class="n">times</span>
                           <span class="o">-</span> <span class="n">DateTime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span><span class="o">.</span><span class="n">secs</span><span class="p">)</span> <span class="o">/</span> <span class="mf">86400.0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;t_phase&#39;</span><span class="p">):</span>
            <span class="n">time2000</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="s1">&#39;2000:001:00:00:00&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">secs</span>
            <span class="n">time2010</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="s1">&#39;2010:001:00:00:00&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">secs</span>
            <span class="n">secs_per_year</span> <span class="o">=</span> <span class="p">(</span><span class="n">time2010</span> <span class="o">-</span> <span class="n">time2000</span><span class="p">)</span> <span class="o">/</span> <span class="mf">10.0</span>
            <span class="n">t_year</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pitch_comp</span><span class="o">.</span><span class="n">times</span> <span class="o">-</span> <span class="n">time2000</span><span class="p">)</span> <span class="o">/</span> <span class="n">secs_per_year</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t_phase</span> <span class="o">=</span> <span class="n">t_year</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>

        <span class="c1"># Interpolate power(pitch) for each instrument separately and make 2d</span>
        <span class="c1"># stack</span>
        <span class="n">n_p</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P_pitches</span><span class="p">)</span>
        <span class="n">n_instr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instr_names</span><span class="p">)</span>
        <span class="n">heats</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dPs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parvals</span><span class="p">[</span><span class="n">n_instr</span> <span class="o">*</span> <span class="n">n_p</span><span class="p">:(</span><span class="n">n_instr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">n_p</span><span class="p">]</span>
        <span class="n">dP_vals</span> <span class="o">=</span> <span class="n">Ska</span><span class="o">.</span><span class="n">Numpy</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">dPs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">P_pitches</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pitches</span><span class="p">)</span>
        <span class="n">d_heat</span> <span class="o">=</span> <span class="p">(</span><span class="n">dP_vals</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_days</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">)</span>
                  <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ampl</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_phase</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_instr</span><span class="p">):</span>
            <span class="n">P_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parvals</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n_p</span><span class="p">:(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">n_p</span><span class="p">]</span>
            <span class="n">heat</span> <span class="o">=</span> <span class="n">Ska</span><span class="o">.</span><span class="n">Numpy</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">P_vals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">P_pitches</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pitches</span><span class="p">)</span>
            <span class="n">heats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">heat</span> <span class="o">+</span> <span class="n">d_heat</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">heats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">heats</span><span class="p">)</span>

        <span class="c1"># Now pick out the power(pitch) for the appropriate instrument at each</span>
        <span class="c1"># time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dvals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heats</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">instrs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heats</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>

        <span class="c1"># Increase heat power for times when detector housing heater is enabled</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dvals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dh_heater_comp</span><span class="o">.</span><span class="n">dvals</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dh_heater</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dvals</span>

    <span class="k">def</span> <span class="nf">plot_solar_heat__pitch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
        <span class="n">P_vals</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instr_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hrcs&#39;</span><span class="p">,</span> <span class="s1">&#39;hrci&#39;</span><span class="p">,</span> <span class="s1">&#39;aciss&#39;</span><span class="p">,</span> <span class="s1">&#39;acisi&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">instr_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">instr_names</span><span class="p">:</span>
            <span class="n">P_vals</span><span class="p">[</span><span class="n">instr_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">pitch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">P_pitches</span><span class="p">:</span>
                <span class="n">P_vals</span><span class="p">[</span><span class="n">instr_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;P_</span><span class="si">{0}</span><span class="s1">_</span><span class="si">{1:d}</span><span class="s1">&#39;</span>
                                                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">instr_name</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">pitch</span><span class="p">))))</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">]</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">instr_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instr_names</span><span class="p">):</span>
                <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P_pitches</span><span class="p">,</span> <span class="n">P_vals</span><span class="p">[</span><span class="n">instr_name</span><span class="p">])</span>
                <span class="c1"># lines[i * 2 + 1].set_data(self.P_pitches, P_vals[instr_name], &#39;-b&#39;)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">instr_name</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instr_names</span><span class="p">,</span> <span class="n">colors</span><span class="p">):</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P_pitches</span><span class="p">,</span> <span class="n">P_vals</span><span class="p">[</span><span class="n">instr_name</span><span class="p">],</span> <span class="s1">&#39;o-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">color</span><span class="p">),</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                        <span class="n">label</span><span class="o">=</span><span class="n">instr_name</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> solar heat input&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">180</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;psmc_solarheat__</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span></div>


<div class="viewcode-block" id="AcisPsmcPower"><a class="viewcode-back" href="../../../api.html#xija.component.heat.AcisPsmcPower">[docs]</a><span class="k">class</span> <span class="nc">AcisPsmcPower</span><span class="p">(</span><span class="n">PrecomputedHeatPower</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Heating from ACIS electronics (ACIS config dependent CCDs, FEPs etc)&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="n">ModelComponent</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_comp</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_mvals</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_par</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;psmc__</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dvals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_dvals&#39;</span><span class="p">):</span>
            <span class="n">deav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">&#39;1de28avo&#39;</span><span class="p">)</span>
            <span class="n">deai</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">&#39;1deicacu&#39;</span><span class="p">)</span>
            <span class="n">dpaav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">&#39;1dp28avo&#39;</span><span class="p">)</span>
            <span class="n">dpaai</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">&#39;1dpicacu&#39;</span><span class="p">)</span>
            <span class="n">dpabv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">&#39;1dp28bvo&#39;</span><span class="p">)</span>
            <span class="n">dpabi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">&#39;1dpicbcu&#39;</span><span class="p">)</span>
            <span class="c1"># maybe smooth? (already 5min telemetry, no need)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dvals</span> <span class="o">=</span> <span class="n">deav</span> <span class="o">*</span> <span class="n">deai</span> <span class="o">+</span> <span class="n">dpaav</span> <span class="o">*</span> <span class="n">dpaai</span> <span class="o">+</span> <span class="n">dpabv</span> <span class="o">*</span> <span class="n">dpabi</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dvals</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mvals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dvals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmal_ints</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmal</span><span class="o">.</span><span class="n">OPCODES</span><span class="p">[</span><span class="s1">&#39;precomputed_heat&#39;</span><span class="p">],</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">mvals_i</span><span class="p">,</span>  <span class="c1"># dy1/dt index</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">mvals_i</span><span class="p">,</span>  <span class="c1"># mvals with precomputed heat input</span>
                          <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmal_floats</span> <span class="o">=</span> <span class="p">()</span></div>


<div class="viewcode-block" id="AcisDpaPower"><a class="viewcode-back" href="../../../api.html#xija.component.heat.AcisDpaPower">[docs]</a><span class="k">class</span> <span class="nc">AcisDpaPower</span><span class="p">(</span><span class="n">PrecomputedHeatPower</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Heating from ACIS electronics (ACIS config dependent CCDs, FEPs etc)&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="n">ModelComponent</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_comp</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_par</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_par</span><span class="p">(</span><span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="mf">70.0</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">100.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_mvals</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;dpa__</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>

<div class="viewcode-block" id="AcisDpaPower.get_dvals_tlm"><a class="viewcode-back" href="../../../api.html#xija.component.heat.AcisDpaPower.get_dvals_tlm">[docs]</a>    <span class="k">def</span> <span class="nf">get_dvals_tlm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Model dvals is set to the telemetered power.  This is not actually</span>
<span class="sd">        used by the model, but is useful for diagnostics.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dvals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">&#39;dp_dpa_power&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">dvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">times</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dvals</span></div>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mvals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dvals</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span><span class="p">)</span> <span class="o">/</span> <span class="mf">10.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmal_ints</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmal</span><span class="o">.</span><span class="n">OPCODES</span><span class="p">[</span><span class="s1">&#39;precomputed_heat&#39;</span><span class="p">],</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">mvals_i</span><span class="p">,</span>  <span class="c1"># dy1/dt index</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">mvals_i</span><span class="p">,</span>  <span class="c1"># mvals with precomputed heat input</span>
                          <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmal_floats</span> <span class="o">=</span> <span class="p">()</span>

    <span class="k">def</span> <span class="nf">plot_data__time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_plotdate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dvals</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plot_cxctime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">times</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dvals</span><span class="p">,</span> <span class="s1">&#39;#386cb0&#39;</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: data (blue)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Power (W)&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AcisDeaPower"><a class="viewcode-back" href="../../../api.html#xija.component.heat.AcisDeaPower">[docs]</a><span class="k">class</span> <span class="nc">AcisDeaPower</span><span class="p">(</span><span class="n">PrecomputedHeatPower</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Heating from ACIS DEA&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="n">ModelComponent</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_comp</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_par</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_mvals</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;dea__</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dvals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_dvals&#39;</span><span class="p">):</span>
            <span class="n">deav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">&#39;1de28avo&#39;</span><span class="p">)</span>
            <span class="n">deai</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">&#39;1deicacu&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dvals</span> <span class="o">=</span> <span class="n">deav</span> <span class="o">*</span> <span class="n">deai</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dvals</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mvals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dvals</span> <span class="o">/</span> <span class="mf">10.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmal_ints</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmal</span><span class="o">.</span><span class="n">OPCODES</span><span class="p">[</span><span class="s1">&#39;precomputed_heat&#39;</span><span class="p">],</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">mvals_i</span><span class="p">,</span>  <span class="c1"># dy1/dt index</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">mvals_i</span><span class="p">,</span>
                          <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmal_floats</span> <span class="o">=</span> <span class="p">()</span>

    <span class="k">def</span> <span class="nf">plot_data__time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_plotdate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dvals</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plot_cxctime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">times</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dvals</span><span class="p">,</span> <span class="s1">&#39;#386cb0&#39;</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: data (blue)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Power (W)&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AcisDpaStatePower"><a class="viewcode-back" href="../../../api.html#xija.component.heat.AcisDpaStatePower">[docs]</a><span class="k">class</span> <span class="nc">AcisDpaStatePower</span><span class="p">(</span><span class="n">PrecomputedHeatPower</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Heating from ACIS electronics (ACIS config dependent CCDs, FEPs etc).</span>
<span class="sd">    Use commanded states and assign an effective power for each &quot;unique&quot; power</span>
<span class="sd">    state.  See dpa/NOTES.power.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">mult</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                 <span class="n">fep_count</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ccd_count</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">vid_board</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clocking</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">pow_states</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AcisDpaStatePower</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_comp</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fep_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_comp</span><span class="p">(</span><span class="n">fep_count</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ccd_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_comp</span><span class="p">(</span><span class="n">ccd_count</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vid_board</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_comp</span><span class="p">(</span><span class="n">vid_board</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clocking</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_comp</span><span class="p">(</span><span class="n">clocking</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pow_states</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pow_states</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;0xxx&quot;</span><span class="p">,</span> <span class="s2">&quot;1xxx&quot;</span><span class="p">,</span> <span class="s2">&quot;2xxx&quot;</span><span class="p">,</span> <span class="s2">&quot;3xx0&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;3xx1&quot;</span><span class="p">,</span> <span class="s2">&quot;4xxx&quot;</span><span class="p">,</span> <span class="s2">&quot;5xxx&quot;</span><span class="p">,</span> <span class="s2">&quot;66x0&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;6611&quot;</span><span class="p">,</span> <span class="s2">&quot;6xxx&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ps</span> <span class="ow">in</span> <span class="n">pow_states</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_par</span><span class="p">(</span><span class="s1">&#39;pow_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ps</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_par</span><span class="p">(</span><span class="s1">&#39;mult&#39;</span><span class="p">,</span> <span class="n">mult</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_par</span><span class="p">(</span><span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">power_pars</span> <span class="o">=</span> <span class="p">[</span><span class="n">par</span> <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span>
                           <span class="k">if</span> <span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;pow_&#39;</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_mvals</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_times</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;dpa_power&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">par_idxs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_par_idxs&#39;</span><span class="p">):</span>
            <span class="c1"># Make a regex corresponding to the last bit of each power</span>
            <span class="c1"># parameter name.  E.g. &quot;pow_1xxx&quot; =&gt; &quot;1...&quot;.</span>
            <span class="n">power_par_res</span> <span class="o">=</span> <span class="p">[</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_pars</span><span class="p">]</span>

            <span class="n">par_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6612</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">fep_count</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ccd_count</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">vid_board</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">clocking</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                            <span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}{}{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fep_count</span><span class="p">,</span> <span class="n">ccd_count</span><span class="p">,</span>
                                                      <span class="n">vid_board</span><span class="p">,</span> <span class="n">clocking</span><span class="p">)</span>
                            <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">power_par_re</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">power_par_res</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">power_par_re</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
                                    <span class="n">par_idxs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
                                    <span class="k">break</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No match for power state </span><span class="si">{}</span><span class="s1">&#39;</span>
                                                 <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>

            <span class="n">idxs</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fep_count</span><span class="o">.</span><span class="n">dvals</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ccd_count</span><span class="o">.</span><span class="n">dvals</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">+</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vid_board</span><span class="o">.</span><span class="n">dvals</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">clocking</span><span class="o">.</span><span class="n">dvals</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_par_idxs</span> <span class="o">=</span> <span class="n">par_idxs</span><span class="p">[</span><span class="n">idxs</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_par_idxs</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Fatal problem with par_idxs routine&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_par_idxs</span>

<div class="viewcode-block" id="AcisDpaStatePower.get_dvals_tlm"><a class="viewcode-back" href="../../../api.html#xija.component.heat.AcisDpaStatePower.get_dvals_tlm">[docs]</a>    <span class="k">def</span> <span class="nf">get_dvals_tlm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Model dvals is set to the telemetered power.  This is not actually</span>
<span class="sd">        used by the model, but is useful for diagnostics.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dvals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">&#39;dp_dpa_power&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">dvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">times</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dvals</span></div>

<div class="viewcode-block" id="AcisDpaStatePower.update"><a class="viewcode-back" href="../../../api.html#xija.component.heat.AcisDpaStatePower.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the model prediction as a precomputed heat.  Make an array of</span>
<span class="sd">        the current power parameters, then slice that with self.par_idxs to</span>
<span class="sd">        generate the predicted power (based on the parameter specifying state</span>
<span class="sd">        power) at each time step.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">power_parvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">par</span><span class="o">.</span><span class="n">val</span> <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_pars</span><span class="p">])</span>
        <span class="n">powers</span> <span class="o">=</span> <span class="n">power_parvals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">par_idxs</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mvals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mult</span> <span class="o">/</span> <span class="mf">100.</span> <span class="o">*</span> <span class="p">(</span><span class="n">powers</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmal_ints</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmal</span><span class="o">.</span><span class="n">OPCODES</span><span class="p">[</span><span class="s1">&#39;precomputed_heat&#39;</span><span class="p">],</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">mvals_i</span><span class="p">,</span>  <span class="c1"># dy1/dt index</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">mvals_i</span><span class="p">,</span>
                          <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmal_floats</span> <span class="o">=</span> <span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">plot_data__time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
        <span class="n">powers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mvals</span> <span class="o">*</span> <span class="mf">100.</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mult</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_plotdate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dvals</span><span class="p">)</span>
            <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_plotdate</span><span class="p">,</span> <span class="n">powers</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plot_cxctime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">times</span><span class="p">,</span> <span class="n">powers</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span>
                         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#d92121&#39;</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="n">plot_cxctime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">times</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dvals</span><span class="p">,</span>
                         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#386cb0&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: model (red) and data (blue)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Power (W)&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="PropHeater"><a class="viewcode-back" href="../../../api.html#xija.component.heat.PropHeater">[docs]</a><span class="k">class</span> <span class="nc">PropHeater</span><span class="p">(</span><span class="n">PrecomputedHeatPower</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Proportional heater (P = k * (T_set - T) for T &lt; T_set).&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">node_control</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">T_set</span><span class="o">=</span><span class="mf">20.0</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PropHeater</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_comp</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_control</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="k">if</span> <span class="n">node_control</span> <span class="ow">is</span> <span class="kc">None</span>
                             <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_comp</span><span class="p">(</span><span class="n">node_control</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_par</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_par</span><span class="p">(</span><span class="s1">&#39;T_set&#39;</span><span class="p">,</span> <span class="n">T_set</span><span class="p">,</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">50.0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">100.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_mvals</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;prop_heat__</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>

<div class="viewcode-block" id="PropHeater.get_dvals_tlm"><a class="viewcode-back" href="../../../api.html#xija.component.heat.PropHeater.get_dvals_tlm">[docs]</a>    <span class="k">def</span> <span class="nf">get_dvals_tlm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">times</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmal_ints</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmal</span><span class="o">.</span><span class="n">OPCODES</span><span class="p">[</span><span class="s1">&#39;proportional_heater&#39;</span><span class="p">],</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">mvals_i</span><span class="p">,</span>  <span class="c1"># dy1/dt index</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">node_control</span><span class="o">.</span><span class="n">mvals_i</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">mvals_i</span>
                          <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmal_floats</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_set</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_data__time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_plotdate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mvals</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plot_cxctime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">times</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mvals</span><span class="p">,</span> <span class="s1">&#39;#386cb0&#39;</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: data (blue)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Power&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ThermostatHeater"><a class="viewcode-back" href="../../../api.html#xija.component.heat.ThermostatHeater">[docs]</a><span class="k">class</span> <span class="nc">ThermostatHeater</span><span class="p">(</span><span class="n">ActiveHeatPower</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Thermostat heater (no deadband): heat = P for T &lt; T_set).&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">node_control</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">P</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">T_set</span><span class="o">=</span><span class="mf">20.0</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ThermostatHeater</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_comp</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_control</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="k">if</span> <span class="n">node_control</span> <span class="ow">is</span> <span class="kc">None</span>
                             <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_comp</span><span class="p">(</span><span class="n">node_control</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_par</span><span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_par</span><span class="p">(</span><span class="s1">&#39;T_set&#39;</span><span class="p">,</span> <span class="n">T_set</span><span class="p">,</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">50.0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">100.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_mvals</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;thermostat_heat__</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>

<div class="viewcode-block" id="ThermostatHeater.get_dvals_tlm"><a class="viewcode-back" href="../../../api.html#xija.component.heat.ThermostatHeater.get_dvals_tlm">[docs]</a>    <span class="k">def</span> <span class="nf">get_dvals_tlm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">times</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmal_ints</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmal</span><span class="o">.</span><span class="n">OPCODES</span><span class="p">[</span><span class="s1">&#39;thermostat_heater&#39;</span><span class="p">],</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">mvals_i</span><span class="p">,</span>  <span class="c1"># dy1/dt index</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">node_control</span><span class="o">.</span><span class="n">mvals_i</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">mvals_i</span>
                          <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmal_floats</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_set</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_data__time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_plotdate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mvals</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plot_cxctime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">times</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mvals</span><span class="p">,</span> <span class="s1">&#39;#386cb0&#39;</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: data (blue)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Power&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="StepFunctionPower"><a class="viewcode-back" href="../../../api.html#xija.component.heat.StepFunctionPower">[docs]</a><span class="k">class</span> <span class="nc">StepFunctionPower</span><span class="p">(</span><span class="n">PrecomputedHeatPower</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A class that applies a constant heat power shift only</span>
<span class="sd">    after a certain point in time.  The shift is 0.0 before</span>
<span class="sd">    ``time`` and ``P`` after ``time``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model :</span>
<span class="sd">        parent model object</span>
<span class="sd">    node :</span>
<span class="sd">        node name or object for which to apply shift</span>
<span class="sd">    time :</span>
<span class="sd">        time of step function shift</span>
<span class="sd">    P :</span>
<span class="sd">        size of shift in heat power (default=0.0)</span>
<span class="sd">    id :</span>
<span class="sd">        str, identifier to allow multiple steps (default=&#39;&#39;)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">P</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">StepFunctionPower</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">time</span><span class="p">)</span><span class="o">.</span><span class="n">secs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_comp</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_mvals</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_par</span><span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">10.0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;step_power</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">__</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="si">}</span><span class="s1">&#39;</span>

<div class="viewcode-block" id="StepFunctionPower.get_dvals_tlm"><a class="viewcode-back" href="../../../api.html#xija.component.heat.StepFunctionPower.get_dvals_tlm">[docs]</a>    <span class="k">def</span> <span class="nf">get_dvals_tlm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">times</span><span class="p">)</span></div>

<div class="viewcode-block" id="StepFunctionPower.update"><a class="viewcode-back" href="../../../api.html#xija.component.heat.StepFunctionPower.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the model prediction as a precomputed heat.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">times</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">)</span>
        <span class="n">idx0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">times</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mvals</span><span class="p">[:</span><span class="n">idx0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmal_ints</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmal</span><span class="o">.</span><span class="n">OPCODES</span><span class="p">[</span><span class="s1">&#39;precomputed_heat&#39;</span><span class="p">],</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">mvals_i</span><span class="p">,</span>  <span class="c1"># dy1/dt index</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">mvals_i</span><span class="p">,</span>
                          <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmal_floats</span> <span class="o">=</span> <span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">plot_data__time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_plotdate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mvals</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plot_cxctime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">times</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mvals</span><span class="p">,</span> <span class="s1">&#39;#386cb0&#39;</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: data (blue)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Power&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="MsidStatePower"><a class="viewcode-back" href="../../../api.html#xija.component.heat.MsidStatePower">[docs]</a><span class="k">class</span> <span class="nc">MsidStatePower</span><span class="p">(</span><span class="n">PrecomputedHeatPower</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class that applies a constant heat power shift only when the state of an</span>
<span class="sd">    MSID, ``state_msid``, matches a specified value, ``state_val``.  The shift</span>
<span class="sd">    is ``P`` when the ``state_val`` for ``state_msid`` is matched, otherwise it</span>
<span class="sd">    is 0.0.</span>

<span class="sd">    :param model: parent model object</span>
<span class="sd">    :param node: node name or object for which to apply shift</span>
<span class="sd">    :param state_msid: state MSID name</span>
<span class="sd">    :param state_val: value of ``state_msid`` to be matched</span>
<span class="sd">    :param P: size of shift in heat power (default=0.0)</span>

<span class="sd">    The name of this component is constructed by concatenating the state msid name</span>
<span class="sd">    and the state msid value with an underscore. For example, if the ``MsidStatePower``</span>
<span class="sd">    component defines a power value for when the COSSRBX values match the string,</span>
<span class="sd">    &quot;ON &quot;, the name of this component is ``cossrbx_on``.</span>

<span class="sd">    The ``dvals`` data stored for this component are a boolean type. To initialize</span>
<span class="sd">    this component, one would use the following syntax:</span>
<span class="sd">        model.comp[&#39;cossrbx_on&#39;].set_data(True)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">state_msid</span><span class="p">,</span> <span class="n">state_val</span><span class="p">,</span> <span class="n">P</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MsidStatePower</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_comp</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_msid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">state_msid</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_val</span> <span class="o">=</span> <span class="n">state_val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_val_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">state_val</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_mvals</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_par</span><span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">10.0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">state_msid</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">state_val_str</span><span class="si">}</span><span class="s1">&#39;</span>

<div class="viewcode-block" id="MsidStatePower.get_dvals_tlm"><a class="viewcode-back" href="../../../api.html#xija.component.heat.MsidStatePower.get_dvals_tlm">[docs]</a>    <span class="k">def</span> <span class="nf">get_dvals_tlm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an array of power values where the power is ``P`` when the</span>
<span class="sd">        ``state_val`` for ``state_msid`` is matched, otherwise it is 0.0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dvals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_msid</span><span class="p">,</span> <span class="s1">&#39;vals&#39;</span><span class="p">,</span> <span class="s1">&#39;nearest&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_val</span>
        <span class="k">return</span> <span class="n">dvals</span></div>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">times</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mvals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dvals</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">P</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmal_ints</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmal</span><span class="o">.</span><span class="n">OPCODES</span><span class="p">[</span><span class="s1">&#39;precomputed_heat&#39;</span><span class="p">],</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">mvals_i</span><span class="p">,</span>  <span class="c1"># dy1/dt index</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">mvals_i</span><span class="p">,</span>
                          <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmal_floats</span> <span class="o">=</span> <span class="p">()</span>

    <span class="k">def</span> <span class="nf">plot_data__time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">plot_cxctime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">times</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dvals</span><span class="p">,</span> <span class="s1">&#39;#386cb0&#39;</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">: state match dvals (blue)&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">state_msid</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1"> == </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_val</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="quat_to_transform_transpose"><a class="viewcode-back" href="../../../api.html#xija.component.heat.quat_to_transform_transpose">[docs]</a><span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">quat_to_transform_transpose</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    q :</span>


<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    type</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">q</span>
    <span class="n">xx2</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span>
    <span class="n">yy2</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">y</span> <span class="o">*</span> <span class="n">y</span>
    <span class="n">zz2</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">z</span> <span class="o">*</span> <span class="n">z</span>
    <span class="n">xy2</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span>
    <span class="n">wz2</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">w</span> <span class="o">*</span> <span class="n">z</span>
    <span class="n">zx2</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">z</span> <span class="o">*</span> <span class="n">x</span>
    <span class="n">wy2</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">w</span> <span class="o">*</span> <span class="n">y</span>
    <span class="n">yz2</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">y</span> <span class="o">*</span> <span class="n">z</span>
    <span class="n">wx2</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">w</span> <span class="o">*</span> <span class="n">x</span>

    <span class="n">rmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">rmat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">yy2</span> <span class="o">-</span> <span class="n">zz2</span>
    <span class="n">rmat</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">xy2</span> <span class="o">-</span> <span class="n">wz2</span>
    <span class="n">rmat</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">zx2</span> <span class="o">+</span> <span class="n">wy2</span>
    <span class="n">rmat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">xy2</span> <span class="o">+</span> <span class="n">wz2</span>
    <span class="n">rmat</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">xx2</span> <span class="o">-</span> <span class="n">zz2</span>
    <span class="n">rmat</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">yz2</span> <span class="o">-</span> <span class="n">wx2</span>
    <span class="n">rmat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">zx2</span> <span class="o">-</span> <span class="n">wy2</span>
    <span class="n">rmat</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">yz2</span> <span class="o">+</span> <span class="n">wx2</span>
    <span class="n">rmat</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">xx2</span> <span class="o">-</span> <span class="n">yy2</span>

    <span class="k">return</span> <span class="n">rmat</span></div>


<span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_dists_lons_lats</span><span class="p">(</span><span class="n">ephems</span><span class="p">,</span> <span class="n">q_atts</span><span class="p">):</span>
    <span class="n">n_vals</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ephems</span><span class="p">)</span>
    <span class="n">lons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n_vals</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">lats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n_vals</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n_vals</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="n">ephems</span> <span class="o">=</span> <span class="o">-</span><span class="n">ephems</span>  <span class="c1"># swap to Chandra-body-centric</span>

    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_vals</span><span class="p">):</span>
        <span class="n">ephem</span> <span class="o">=</span> <span class="n">ephems</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">q_att</span> <span class="o">=</span> <span class="n">q_atts</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="c1"># Earth vector in Chandra body coords (p_earth_body)</span>
        <span class="n">xform</span> <span class="o">=</span> <span class="n">quat_to_transform_transpose</span><span class="p">(</span><span class="n">q_att</span><span class="p">)</span>
        <span class="n">peb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">xform</span><span class="p">,</span> <span class="n">ephem</span><span class="p">)</span>

        <span class="c1"># Convert cartesian to spherical coords</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">peb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">peb</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">dists</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">peb</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">lons</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">peb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">peb</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">lats</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">peb</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">s</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dists</span><span class="p">,</span> <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


<form action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2016, Tom Aldcroft.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 3.1.2. &nbsp;
  </p>
</footer>
  </body>
</html>